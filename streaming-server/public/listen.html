<html>

<body>
    <h1>Lag time: <span id="time"></span></h1>
    <h2 id="collected"></h2><button onclick="collect()">Probe</button>
    <script>
        const evtSource = new EventSource("/streaming");

        function getData(event) {
            try {
                return JSON.parse(event.data)
            } catch (e) {
                return {}
            }
        }

        evtSource.onmessage = (event) => {
            const data = getData(event);
            console.log(`message:`, data);
        };

        evtSource.addEventListener('ping', function (event) {
            const data = getData(event);
            let lag = Date.now() - data.time;
            time.innerText = `${lag}ms`;
            console.log('ping', event, data, lag);
        });

        function collect() {
            const now = Date.now();
            const collect_once = (event) => {
                const data = getData(event);
                collected.innerText = `Collect RTT: ${Date.now() - data.time}ms`
                evtSource.removeEventListener('collect', collect_once);
            }

            evtSource.addEventListener('collect', collect_once);

            fetch('/collect', {
                method: 'POST',
                headers: {
                    // 'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    time: now
                })
            })
        }
    </script>
</body>

</html>