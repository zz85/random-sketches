<!DOCTYPE html>
<html lang="en">

<head>
    <title>Sun charts</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="//writ.cmcenroe.me/1.0.4/writ.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/charts.css/dist/charts.min.css">
    <style>
        .arrow {
            font-size: 10px;
            padding: 0px 0px 0px 10px;
            margin: 0px;
            display: inline-block;
            transform-origin: 80% 50%;
        }

        .sunlightPie {
            display: inline-block;
            height: 14px;
            width: 14px;
            /* max-width: 15px; */
            /* width: 25px; */
        }

        .sunlightBar {
            width: 100px;
            margin: 0 auto;
        }

        .sunlightBar .bar {
            --color: orange;
        }

        .sunlightBar .legend {}
    </style>
</head>


<body>

    <script src="locator.js"></script>
    <script src="vendor/suncalc.js"></script>
    <header>
        <h1>Sun Charts</h1>
        <p>
            Sunrise and sunset timings for a year<br />
            an experiment using web geolocation API with suncalc.js</p>
    </header>
    <main>
        <p id="locLabel"></p>
        <button onclick="locator.getLocation(update);">Update my location</button>
        <p>
            <p id="charts" />

        <p id="viz"></p>
        </p>
    </main>

    <script>
        const locator = new Locator();

        const ONE_SEC = 1000;
        const ONE_MIN = ONE_SEC * 60;
        const ONE_HOUR = ONE_MIN * 60;
        const ONE_DAY = ONE_HOUR * 24;

        if (!locator.timestamp) {
            locator.getLocation(update);
        } else {
            update();
        }

        function update() {
            locLabel.innerHTML = `Location: ${locator.latitude.toFixed(3)}, ${locator.longitude.toFixed(3)}
    <br/>Updated: ${new Date(locator.timestamp)}`;

            getCharts(locator.latitude, locator.longitude);
            plotSun(new Date(), locator.latitude, locator.longitude)
        }

        function plotSun(date, lat, lon) {
            date.setSeconds(0);
            date.setMinutes(0);

            var ctx = createCanvas(1600, 800)
            var viz = document.getElementById('viz')
            viz.replaceChildren(ctx.dom);

            var points = [];
            const MINS_A_DAY = 60 * 24;
            const base = 200;
            const hour_w = MINS_A_DAY / 24 / 2;

            ctx.beginPath();
            ctx.moveTo(0, base);
            ctx.lineTo(25 * hour_w, base);
            ctx.stroke();

            for (let h = 0; h < 24; h += 1) {
                date.setHours(h);
                const pos = SunCalc.getPosition(date, lat, lon);

                const alt = getAngle(pos.altitude);

                // getAngle()
                ctx.fillText(`${h}`, (h + 0) * hour_w, 50);

                ctx.beginPath();
                ctx.arc((h + 0) * hour_w, base - alt * 2, 5, 0, Math.PI * 2)
                ctx.stroke();
                ctx.fillText(`${alt.toFixed()}°`, (h + 0) * hour_w, base - alt * 2 - 30);

                points.push(alt)
            }

            // ctx.beginPath();
            // points.forEach((alt, h) => {
            //     ctx.lineTo((h + 0) * hour_w, base - alt * 2)
            // })
            // ctx.stroke();

            date.setHours(0);
            ctx.lineWidth = 0.05;
            ctx.beginPath();

            for (let min = 0; min < MINS_A_DAY * 400; min += 1) { // 3, 15, 30 could still work
                const pos = SunCalc.getPosition(new Date(date.getTime() + min * ONE_MIN), lat, lon);
                const alt = getAngle(pos.altitude);

                const mod_min = min % MINS_A_DAY;
                ctx.lineTo(mod_min / 2, base - alt * 2)

                // if (mod_min == 0) {
                if (mod_min == MINS_A_DAY - 1) {
                    ctx.stroke();
                    ctx.beginPath();
                    const day = min / MINS_A_DAY | 0;
                    const density = day / 400 * 255;
                    ctx.strokeStyle = `rgb(${density}, ${density}, ${density})`
                }

            }
        }

        function createCanvas(w, h) {
            var canvas = document.createElement('canvas');
            var dpr = window.devicePixelRatio;
            canvas.width = w * dpr;
            canvas.height = h * dpr;
            canvas.style.width = `${w}px`
            canvas.style.height = `${h}px`

            var ctx = canvas.getContext('2d')
            ctx.scale(dpr, dpr)
            ctx.w = w;
            ctx.h = h;
            ctx.dom = canvas;
            return ctx;
        }

        function getCharts(lat, lon) {
            var now = new Date();

            let days = [];
            for (let day = -10; day < 365; day++) {
                const times = SunCalc.getTimes(new Date(now.getTime() + day * ONE_DAY), lat, lon);
                const date = getLocalDate(times.sunrise);
                const sunrise = getLocalTime(times.sunrise);
                const sunset = getLocalTime(times.sunset);
                const daylight = times.sunset - times.sunrise;
                const sunrisePos = SunCalc.getPosition(times.sunrise, lat, lon);
                const sunsetPos = SunCalc.getPosition(times.sunset, lat, lon);

                days.push({
                    day, times, date, sunrise, sunset, daylight, sunrisePos, sunsetPos
                })
            }

            const sortByDaylight = days.concat();
            sortByDaylight.sort((a, b) => a.daylight - b.daylight);
            const shortestDay = sortByDaylight[0]; // winter solstice
            const longestDay = sortByDaylight[sortByDaylight.length - 1]; // summer solstice
            const today = days[10];
            console.log(shortestDay, longestDay);

            var info = `
            Today: ${template(today)}<br/>
            Shortest day: ${template(shortestDay)}<br/>
            Longest day: ${template(longestDay)}<br/>`

            function template(day) {
                return `${day.date}, sunrise at ${day.sunrise}, sunset at ${day.sunset}, ${msToTime(day.daylight)} of daylight`
            }

            var table = [`<table>
                <thead>
                <tr>
                    <td>date</td>
                    <td>sunrise</td>
                    <td>sunset</td>
                    <!--<td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td>-->
                    <td>daylight</td>
                </tr>
                </thead><tbody>`];

            days.forEach(({ day, times, date, sunrise, sunset, daylight, sunrisePos, sunsetPos }) => {
                const sunriseDeg = getAngle(sunrisePos.azimuth + Math.PI);
                const sunsetDeg = getAngle(sunsetPos.azimuth + Math.PI);

                table.push(`<tr>
                    <td>${day ? '' : '<mark>'}${date} ${day ? `<small>(day ${day > 0 ? '+' : ''}${day})</small>` : '</mark>'}</td>
                    <td>${sunrise}<span style="transform: rotate(${sunriseDeg}deg);" class="arrow">↑</span><small><small>${fmtAngle(Math.PI + sunrisePos.azimuth)}</small></small></td>
                    <td>${sunset}<span style="transform: rotate(${sunsetDeg}deg);" class="arrow">↑</span><small><small>${fmtAngle(Math.PI + sunsetPos.azimuth)}</small></small></td>
                    <td>${sunlightPie(daylight / ONE_DAY)} ${msToTime(daylight)} <small>(${today.daylight > daylight ? '-' : '+'}${msToTime(Math.abs(today.daylight - daylight))})</small></td>                    
                    </tr>`)
            });
            table.push(`</tbody></table>`)
            charts.innerHTML = info + table.join('')
        }

        function pad(str) {
            const fmt = `00${str}`
            return fmt.slice(fmt.length - 2)
        }

        function getLocal(date) {
            return `${getLocalDate(date)} ${getLocalTime(date)}`
        }

        function getLocalTime(date) {
            return `${pad(date.getHours())}:${pad(date.getMinutes())}`
            //  + `:${pad(date.getSeconds())}`
        }

        function getLocalDate(date) {
            return `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())}`
        }

        function getAngle(rad) {
            return rad * 180 / Math.PI;
        }

        function fmtAngle(rad) {
            return `${getAngle(rad).toFixed(0)}°`
        }

        function msToTime(ms) {
            let remain = ms;
            let result = [];
            if (remain > ONE_HOUR) {
                const hour = remain / ONE_HOUR | 0;
                remain %= hour * ONE_HOUR;
                result.push(`${hour}h`)
            }

            if (remain > ONE_MIN) {
                const min = remain / ONE_MIN | 0;
                remain %= min * ONE_MIN;
                result.push(`${min}m`)
            }

            return result.join(' ')
        }

        function sunlightPie(x) {
            return `
            <div class="sunlightPie">
                <table class="charts-css pie hide-data">
                <tbody>
                    <tr>
                    <td style="--start: 0.00; --end: 0.00;">
                        <span class="data"></span>
                    </td>
                    </tr>
                    <tr>
                    <td style="--start: 0.0; --end: ${x};">
                        <span class="data"></span>
                    </td>
                    </tr>
                    <!--
                    -->
                </tbody>
                </table>
            </div>
            `
        }

        function sunlightBar(x, data = '') {
            return `
            <span class="sunlightBar">
                <table class="charts-css bar stacked">
                <tbody>
                    <td style="--start: 0.0; --end: ${x};">
                        <!--<span class="data">${data}</span>-->
                    </td>
                    </tr>
                    <!-- multiple stacked
                    -->
                </tbody>
                </table>
            </span>
            `
        }
    </script>
</body>

</html>