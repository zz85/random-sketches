<!DOCTYPE html>
<html lang="en">

<head>
  <title>Compass</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
</head>

<body>
  <style>
    body {
      margin: 0;
      left: 0;
      top: 0;
    }
  </style>

  <script>
    const LABEL_RADIUS = 120;
    const LINE_START = 80;
    const LINE_END = 95;
    const HEADING_RADIUS = 65;
    const CROSSHAIR_RADIUS = 50;
    const LABEL = 250;
    const INDEX_LEN = 30;

    const CIRCLE_DEG = 360;
    const PI_2 = Math.PI * 2;
    const bearings = { 'N': 0, 'S': 180, 'E': 90, 'W': 270 };

    let heading = 0, count = 0, touchedHeading = null;

    let w = window.innerWidth;
    let h = window.innerHeight;
    var dpr = window.devicePixelRatio;
    var canvas = document.createElement('canvas');
    canvas.width = w * dpr;
    canvas.height = h * dpr;
    canvas.style.width = `${w}px`;
    canvas.style.height = `${h}px`;
    document.body.appendChild(canvas);

    var ctx = canvas.getContext('2d');
    ctx.scale(dpr, dpr);
    ctx.translate(w / 2, h / 2);
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle'
    ctx.fillText(`Click to start`, 0, LABEL)

    function requestPermissions() {
      if (typeof DeviceOrientationEvent.requestPermission !== "function") {
        ctx.fillText(`No DeviceOrientationEvent`, 0, LABEL)
        return;
      }

      DeviceOrientationEvent.requestPermission()
        .then(permissionState => {
          if (permissionState === "granted") {
            // this.compassActive = true;
            window.addEventListener("deviceorientation", handleDeviceOrientation, false);
            draw();
          }
        })
        .catch(e => {
          ctx.fillText(`${e}`, 0, LABEL)
        });
    }

    canvas.addEventListener('click', () => {
      ctx.fillText(`click`, 0, LABEL)
      requestPermissions();
    }, false);

    document.body.addEventListener('touchstart', (e) => {
      e.preventDefault();
      touchedHeading = heading;
    }, false);


    function handleDeviceOrientation(e) {
      heading = e.webkitCompassHeading;
    }

    function angleToCoords(angle, len = 1) {
      const x = Math.cos(angle) * len
      const y = Math.sin(angle) * len

      return [x, y];
    }

    function draw() {
      ctx.clearRect(-w, -w, h, h);
      ctx.fillText(`${Math.round(heading)}Â° - ${touchedHeading}`, 0, LABEL)

      drawDial(heading);

      requestAnimationFrame(draw);
    }

    function drawDial(heading = 0) {
      // draw degree labels
      ctx.save();
      ctx.font = '14px sans-serif'
      for (let r = 0; r < CIRCLE_DEG; r += 30) {
        const [x, y] = angleToCoords((r - heading - 90) / CIRCLE_DEG * PI_2, LABEL_RADIUS)
        ctx.fillText(`${r}`, x, y)
      }

      // draw crosshair
      // N-S
      ctx.lineWidth = 0.5;
      const [nx, ny] = angleToCoords((bearings.N - heading - 90) / CIRCLE_DEG * PI_2,  CROSSHAIR_RADIUS);
      const [sx, sy] = angleToCoords((bearings.S - heading - 90) / CIRCLE_DEG * PI_2,  CROSSHAIR_RADIUS);
      ctx.beginPath();
      ctx.moveTo(nx, ny);
      ctx.lineTo(sx, sy);
      ctx.stroke();
      // E-W
      const [ex, ey] = angleToCoords((bearings.E - heading - 90) / CIRCLE_DEG * PI_2,  CROSSHAIR_RADIUS);
      const [wx, wy] = angleToCoords((bearings.W - heading - 90) / CIRCLE_DEG * PI_2,  CROSSHAIR_RADIUS);
      ctx.beginPath();
      ctx.moveTo(ex, ey);
      ctx.lineTo(wx, wy);
      ctx.stroke();

      // draw heading labels
      for (let dir in bearings) {
        const [x, y] = angleToCoords((bearings[dir] - heading - 90) / CIRCLE_DEG * PI_2,  HEADING_RADIUS);
        ctx.fillText(`${dir}`, x, y)
      }

      for (let r = 0; r < CIRCLE_DEG; r += 2) {
        const [sx, sy] = angleToCoords((r - heading - 90) / CIRCLE_DEG * PI_2)

        ctx.lineWidth = (r % 30 == 0) ? 2 : 0.5;
        ctx.beginPath();
        ctx.moveTo(sx * LINE_START, sy * LINE_START);
        ctx.lineTo(sx * LINE_END, sy * LINE_END);
        ctx.stroke();
      }

      // index line
      ctx.save();
      ctx.globalCompositeOperation = 'xor';
      ctx.beginPath();
      ctx.moveTo(0, -LINE_START);
      ctx.lineTo(0, -LINE_START - INDEX_LEN);
      ctx.lineWidth = 4;
      ctx.stroke();
      ctx.restore();

      ctx.restore();

    }

    drawDial();

  </script>
</body>

</html>